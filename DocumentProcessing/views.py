from django.shortcuts import render
from requests import Response
from rest_framework.decorators import api_view
from django.shortcuts import get_object_or_404
from .models import File, DocumentWord
from .serializers import FileSerializer
from rest_framework import viewsets, status
from rest_framework.authentication import TokenAuthentication
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework.decorators import api_view


class FileView(viewsets.ModelViewSet):
    permission_classes = (IsAuthenticated,)
    authentication_classes = (TokenAuthentication,)
    # SessionAuthentication)

    # basically returns the document list
    queryset = File.objects.all()

    model = File
    serializer_class = FileSerializer

    @api_view(['GET'])
    def ApiOverview(self, request):
        api_urls = {
            'all_files': '/',
            'Add': '/add',
            'Delete': '/file/pk/delete',
            'Patch': 'file/pk/patch',
            'highlight': 'file/pk/highlight'
        }
        return Response(api_urls)

    @api_view(['POST'])
    def add_file(request):

        # request.data['owner_id'] = request.user.id
        file = FileSerializer(data=request.data)

        if file.is_valid():
            file.save()
            return Response(file.data)
        else:
            return Response(status=status.HTTP_400_BAD_REQUEST, data=file.errors)

    @api_view(['GET'])
    def get_files(request):

        files = File.objects.filter(document__owner_id=request.user.id).order_by('document')
        print(files.count())
        print(files.values())

        if files:
            serializer = FileSerializer(files, many=True)
            return Response(serializer.data)
        else:
            data = {'File Count': files.count()}
            return Response(status=status.HTTP_404_NOT_FOUND, data=data)

    @api_view(['DELETE'])
    def delete_file(request, pk):
        file = get_object_or_404(File, pk=pk)
        file.delete()
        return Response(status=status.HTTP_202_ACCEPTED)

    @api_view(['POST'])
    def update_file(request, pk):
        file = File.objects.get(id=pk)
        file.file = request.data['file']
        file.save(update_fields=['file'])
        return Response(FileSerializer(file).data)

    @api_view(['GET'])
    def query_highlight(request, pk):
        file = File.objects.get(id=pk)
        print(file)
        list_points = [{"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.85434238813211, "y": 136.3251344554693},
                       {"x": 110.89357405204542, "y": 136.33486166487197},
                       {"x": 111.84003199218442, "y": 136.55682446592823},
                       {"x": 112.79184722122005, "y": 136.76799373152076},
                       {"x": 113.74849561981809, "y": 136.96880768265657},
                       {"x": 113.74849561981809, "y": 136.96880768265657},
                       {"x": 114.70950203997583, "y": 137.15970017225266},
                       {"x": 115.67443617957473, "y": 137.341098289002},
                       {"x": 115.67443617957473, "y": 137.341098289002},
                       {"x": 116.6429087139465, "y": 137.51342044065908},
                       {"x": 117.6145676881966, "y": 137.67707484769772},
                       {"x": 117.6145676881966, "y": 137.67707484769772},
                       {"x": 118.5890951683736, "y": 137.83245838644774},
                       {"x": 119.5662041453689, "y": 137.97995572831414},
                       {"x": 119.5662041453689, "y": 137.97995572831414},
                       {"x": 120.54563568240019, "y": 138.11993872849573},
                       {"x": 121.5271562948388, "y": 138.25276602375155},
                       {"x": 121.5271562948388, "y": 138.25276602375155},
                       {"x": 122.51055554979145, "y": 138.3787828042384},
                       {"x": 123.4956438720756, "y": 138.49832072929638},
                       {"x": 124.4822505429049, "y": 138.61169796133788},
                       {"x": 125.47022187761493, "y": 138.71921929574725},
                       {"x": 125.47022187761493, "y": 138.71921929574725},
                       {"x": 126.4594195690259, "y": 138.82117636797352},
                       {"x": 127.44971918348394, "y": 138.91784792184555},
                       {"x": 127.44971918348394, "y": 138.91784792184555},
                       {"x": 128.44100879719528, "y": 139.00950012560602},
                       {"x": 129.43318776112002, "y": 139.09638692428973},
                       {"x": 129.43318776112002, "y": 139.09638692428973},
                       {"x": 130.42616558339364, "y": 139.17875041890503},
                       {"x": 131.41986091896771, "y": 139.25682126445042},
                       {"x": 131.41986091896771, "y": 139.25682126445042},
                       {"x": 132.41420065688675, "y": 139.33081908014503},
                       {"x": 133.40911909633198, "y": 139.40095286640098},
                       {"x": 133.40911909633198, "y": 139.40095286640098},
                       {"x": 134.40455720325406, "y": 139.46742142404534},
                       {"x": 135.40046194007917, "y": 139.53041377213012},
                       {"x": 136.3967856615996, "y": 139.59010956137354},
                       {"x": 137.39348557075147, "y": 139.64667948087077},
                       {"x": 137.39348557075147, "y": 139.64667948087077},
                       {"x": 138.39052322853328, "y": 139.7002856562139},
                       {"x": 139.38786411283337, "y": 139.7510820375815},
                       {"x": 140.38547722140848, "y": 139.79921477671127},
                       {"x": 141.38333471469508, "y": 139.84482259196284},
                       {"x": 141.38333471469508, "y": 139.84482259196284},
                       {"x": 142.38141159453673, "y": 139.8880371209224},
                       {"x": 143.37968541528122, "y": 139.9289832602026},
                       {"x": 143.37968541528122, "y": 139.9289832602026},
                       {"x": 144.37813602403727, "y": 139.96777949225714},
                       {"x": 145.37674532719063, "y": 140.00453819916558},
                       {"x": 146.3754970805572, "y": 140.03936596345386},
                       {"x": 147.3743767008087, "y": 140.072363856104},
                       {"x": 147.3743767008087, "y": 140.072363856104},
                       {"x": 148.3733710960352, "y": 140.1036277119777},
                       {"x": 149.37246851352117, "y": 140.13324839293253},
                       {"x": 149.37246851352117, "y": 140.13324839293253},
                       {"x": 150.36999240702266, "y": 140.108742135741},
                       {"x": 151.36943600045606, "y": 140.08548137169097},
                       {"x": 151.36943600045606, "y": 140.08548137169097}]
        words = {}
        for i in list_points:
            print(i.get("x"), i.get("y"))
            word = DocumentWord.objects.filter(file=file, left__lte=i.get("x") * 2.77, top__lte=i.get("y") * 2.7,
                                               right__gte=i.get("x") * 2.77, bottom__gte=i.get("y") * 2.7)
            print(word)

        i = {"x": 330.546, "y": 380.5467}
        word = DocumentWord.objects.filter(file=file, left__lte=i.get("x"), top__lte=i.get("y"),
                                           right__gte=i.get("x"), bottom__gte=i.get("y"))
        print(word)
